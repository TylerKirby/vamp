#!/bin/bash

# vamp: Terminal-native Claude Code development environment
# Like a jazz vamp - keeps the rhythm while you improvise with Claude
#
# Usage: vamp [project-dir]
#        vamp status
#        vamp kill [session-name]
#        vamp list

set -e

VAMP_VERSION="0.3.0"

# Configuration - customize via ~/.config/vamp/config or env vars
FILE_VIEWER="${VAMP_FILE_VIEWER:-yazi}"
MONITOR_CMD="${VAMP_MONITOR:-htop}"
CLAUDE_CMD="${VAMP_CLAUDE_CMD:-claude}"
PROJECTS_DIR="${VAMP_PROJECTS_DIR:-$HOME/Projects}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

# Load config if exists
[ -f "$HOME/.config/vamp/config" ] && source "$HOME/.config/vamp/config"

# ============================================
# Subcommands
# ============================================

show_help() {
    cat << EOF
${CYAN}vamp${NC} v${VAMP_VERSION} - Terminal-native Claude Code environment

${YELLOW}USAGE:${NC}
    vamp [project-dir]     Start dev environment (default: current dir)
    vamp list              List active vamp sessions
    vamp attach <name>     Attach to existing session
    vamp kill <name>       Kill a session
    vamp killall           Kill all vamp sessions
    vamp init              Initialize project with beads + CLAUDE.md
    vamp setup             Install beads hooks for Claude Code + git
    vamp help              Show this help

${YELLOW}EXAMPLES:${NC}
    vamp                   Start in current directory
    vamp ~/Projects/app    Start in specific directory
    vamp attach app        Attach to 'vamp-app' session
    vamp list              Show all running sessions

${YELLOW}KEYBINDINGS:${NC}
    Ctrl-b + arrows        Navigate panes
    Ctrl-b + z             Zoom pane (toggle fullscreen)
    Ctrl-b + d             Detach (session keeps running)
    Ctrl-b + 0             Main window
    Ctrl-b + 1             Git window
    Ctrl-b + 2             Claude monitor window

${YELLOW}MOUSE:${NC}
    Scroll wheel           Scroll pane content
    Click pane             Select pane
    Drag border            Resize pane

${YELLOW}CONFIG:${NC}
    ~/.config/vamp/config

EOF
}

list_sessions() {
    echo -e "${CYAN}Active vamp sessions:${NC}"
    local sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep "^vamp-" || true)
    if [ -z "$sessions" ]; then
        echo -e "${DIM}  No active sessions${NC}"
    else
        echo "$sessions" | while read -r session; do
            local project="${session#vamp-}"
            local windows=$(tmux list-windows -t "$session" -F '#{window_name}' 2>/dev/null | tr '\n' ' ')
            echo -e "  ${GREEN}‚óè${NC} $project ${DIM}[$windows]${NC}"
        done
    fi
}

attach_session() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -e "${RED}Usage: vamp attach <session-name>${NC}"
        list_sessions
        return 1
    fi
    
    local session="vamp-$name"
    if tmux has-session -t "$session" 2>/dev/null; then
        tmux attach-session -t "$session"
    else
        echo -e "${RED}Session '$session' not found${NC}"
        list_sessions
        return 1
    fi
}

kill_session() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -e "${RED}Usage: vamp kill <session-name>${NC}"
        list_sessions
        return 1
    fi
    
    local session="vamp-$name"
    if tmux kill-session -t "$session" 2>/dev/null; then
        echo -e "${GREEN}Killed session: $session${NC}"
    else
        echo -e "${RED}Session '$session' not found${NC}"
    fi
}

kill_all_sessions() {
    local sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep "^vamp-" || true)
    if [ -z "$sessions" ]; then
        echo -e "${DIM}No vamp sessions to kill${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}This will kill:${NC}"
    echo "$sessions" | sed 's/^/  /'
    read -p "Continue? [y/N] " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo "$sessions" | xargs -I {} tmux kill-session -t {}
        echo -e "${GREEN}All vamp sessions killed${NC}"
    fi
}

init_project() {
    local name=$(basename "$(pwd)")
    echo -e "${CYAN}Initializing project: $name${NC}"
    
    # Git
    if [ ! -d ".git" ]; then
        git init
        echo -e "  ${GREEN}‚úì${NC} Initialized git"
    fi
    
    # Beads
    if command -v bd &> /dev/null; then
        if [ ! -d ".beads" ] && [ ! -f ".beads.jsonl" ]; then
            bd init
            echo -e "  ${GREEN}‚úì${NC} Initialized beads"
        else
            echo -e "  ${DIM}‚óã${NC} Beads already initialized"
        fi

        # Install git hooks
        bd hooks install 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Git hooks installed"

        # Check Claude integration
        if ! bd setup claude --check &>/dev/null; then
            echo -e "  ${YELLOW}?${NC} Claude Code hooks not installed"
            echo -e "      Run 'vamp setup' to install globally"
        fi
    else
        echo -e "  ${YELLOW}‚óã${NC} Beads not installed (brew tap steveyegge/beads && brew install beads)"
    fi
    
    # CLAUDE.md
    if [ ! -f "CLAUDE.md" ]; then
        cat > CLAUDE.md << EOF
# $name

## Project Overview
<!-- Brief description -->

## Tech Stack
<!-- Languages, frameworks, dependencies -->

## Development
- Task tracking: \`bd ready\` for available work
- Tests: \`<test command>\`

## Architecture
<!-- Key patterns and decisions -->

## Current Focus
<!-- Active work items -->
EOF
        echo -e "  ${GREEN}‚úì${NC} Created CLAUDE.md"
    else
        echo -e "  ${DIM}‚óã${NC} CLAUDE.md exists"
    fi
    
    # .gitignore
    if ! grep -q ".beads-cache" .gitignore 2>/dev/null; then
        echo -e "\n# Beads cache\n.beads-cache/" >> .gitignore
        echo -e "  ${GREEN}‚úì${NC} Updated .gitignore"
    fi
    
    echo -e "\n${GREEN}Ready! Run 'vamp' to start${NC}"
}

setup_beads() {
    echo -e "${CYAN}Setting up beads integration...${NC}"

    if ! command -v bd &> /dev/null; then
        echo -e "  ${RED}‚úó${NC} beads not installed"
        echo -e "    Install: brew tap steveyegge/beads && brew install beads"
        return 1
    fi

    # Install Claude Code hooks
    echo -e "${BLUE}Installing Claude Code hooks...${NC}"
    bd setup claude
    echo -e "  ${GREEN}‚úì${NC} Claude Code hooks installed"

    # Install git hooks if in a git repo
    if [ -d ".git" ]; then
        echo -e "${BLUE}Installing git hooks...${NC}"
        bd hooks install 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Git hooks installed"
    else
        echo -e "  ${DIM}‚óã${NC} Not a git repo, skipping git hooks"
    fi

    echo ""
    echo -e "${GREEN}Beads integration complete!${NC}"
    echo -e "  Restart Claude Code for hooks to take effect."
    echo -e "  Run 'bd setup claude --check' to verify."
}

# ============================================
# Claude monitor script (runs in pane)
# ============================================

create_claude_monitor() {
    cat << 'MONITOR_SCRIPT'
#!/bin/bash
# Claude Code usage monitor - mirrors /usage data

CLAUDE_DIR="$HOME/.claude"
STATS_FILE="$CLAUDE_DIR/stats-cache.json"

# Colors
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
DIM='\033[2m'
NC='\033[0m'

# Format large numbers (1234567 -> 1.23M)
format_tokens() {
    local n=$1
    if [ -z "$n" ] || [ "$n" = "null" ]; then
        echo "0"
    elif [ "$n" -ge 1000000 ] 2>/dev/null; then
        awk "BEGIN {printf \"%.1fM\", $n/1000000}"
    elif [ "$n" -ge 1000 ] 2>/dev/null; then
        awk "BEGIN {printf \"%.1fK\", $n/1000}"
    else
        echo "$n"
    fi
}

# Draw hourly activity sparkline
draw_sparkline() {
    local hours="$1"
    local chars=(" " "‚ñÅ" "‚ñÇ" "‚ñÉ" "‚ñÑ" "‚ñÖ" "‚ñÜ" "‚ñá" "‚ñà")
    local max=$(echo "$hours" | jq -r 'to_entries | map(.value) | max // 1')

    for h in $(seq 0 23); do
        local count=$(echo "$hours" | jq -r ".[\"$h\"] // 0")
        local idx=0
        if [ "$max" -gt 0 ] && [ "$count" -gt 0 ]; then
            idx=$(awk "BEGIN {printf \"%d\", ($count * 8 / $max)}")
            [ $idx -gt 8 ] && idx=8
        fi
        printf "${chars[$idx]}"
    done
}

while true; do
    clear
    echo -e "${CYAN}‚ïê‚ïê‚ïê Claude Usage ‚ïê‚ïê‚ïê${NC}"
    echo ""

    # Check if stats file exists
    if [ ! -f "$STATS_FILE" ]; then
        echo -e "${DIM}No usage stats yet.${NC}"
        echo "Use Claude Code to generate stats."
        echo ""
        echo -e "${DIM}30s refresh | Ctrl-C exit${NC}"
        sleep 30
        continue
    fi

    # Check jq availability
    if ! command -v jq &> /dev/null; then
        echo -e "${YELLOW}jq required${NC}"
        echo "Install: brew install jq"
        sleep 30
        continue
    fi

    # Parse stats
    STATS=$(cat "$STATS_FILE")
    TODAY=$(date +%Y-%m-%d)

    # ========== TODAY'S STATS ==========
    echo -e "${YELLOW}TODAY${NC} ${DIM}($TODAY)${NC}"

    TODAY_DATA=$(echo "$STATS" | jq -r --arg d "$TODAY" '.dailyActivity[] | select(.date == $d)' 2>/dev/null)
    if [ -n "$TODAY_DATA" ]; then
        MSGS=$(echo "$TODAY_DATA" | jq -r '.messageCount // 0')
        SESSIONS=$(echo "$TODAY_DATA" | jq -r '.sessionCount // 0')
        TOOLS=$(echo "$TODAY_DATA" | jq -r '.toolCallCount // 0')
        printf "  Messages: %s  Sessions: %s\n" "$MSGS" "$SESSIONS"
        printf "  Tool Calls: %s\n" "$TOOLS"
    else
        echo -e "  ${DIM}No activity today${NC}"
    fi

    echo ""

    # ========== TOKEN USAGE BY MODEL ==========
    echo -e "${YELLOW}TOKENS${NC} ${DIM}(All Time)${NC}"

    # Get all model names
    MODELS=$(echo "$STATS" | jq -r '.modelUsage | keys[]' 2>/dev/null)

    for model in $MODELS; do
        # Extract short name (Opus 4.5 or Sonnet 4.5)
        SHORT_NAME=$(echo "$model" | sed 's/claude-//' | sed 's/-[0-9]*$//' | sed 's/-/ /g' | awk '{print toupper(substr($1,1,1)) substr($1,2) " " $2 "." $3}')

        IN=$(echo "$STATS" | jq -r ".modelUsage[\"$model\"].inputTokens // 0")
        OUT=$(echo "$STATS" | jq -r ".modelUsage[\"$model\"].outputTokens // 0")
        CACHE_R=$(echo "$STATS" | jq -r ".modelUsage[\"$model\"].cacheReadInputTokens // 0")
        CACHE_W=$(echo "$STATS" | jq -r ".modelUsage[\"$model\"].cacheCreationInputTokens // 0")

        echo -e "  ${GREEN}$SHORT_NAME${NC}"
        printf "    In: %s  Out: %s\n" "$(format_tokens $IN)" "$(format_tokens $OUT)"
        printf "    Cache: %s read, %s write\n" "$(format_tokens $CACHE_R)" "$(format_tokens $CACHE_W)"
    done

    echo ""

    # ========== LIFETIME STATS ==========
    echo -e "${YELLOW}LIFETIME${NC}"
    TOTAL_SESSIONS=$(echo "$STATS" | jq -r '.totalSessions // 0')
    TOTAL_MSGS=$(echo "$STATS" | jq -r '.totalMessages // 0')
    printf "  Sessions: %s  Messages: %s\n" "$TOTAL_SESSIONS" "$(format_tokens $TOTAL_MSGS)"

    echo ""

    # ========== ACTIVITY SPARKLINE ==========
    echo -e "${YELLOW}ACTIVITY${NC} ${DIM}(by hour)${NC}"
    HOURS=$(echo "$STATS" | jq -r '.hourCounts // {}')
    if [ "$HOURS" != "{}" ] && [ "$HOURS" != "null" ]; then
        printf "  "
        draw_sparkline "$HOURS"
        echo ""
        echo -e "  ${DIM}^0    ^6   ^12   ^18  ^23${NC}"
    else
        echo -e "  ${DIM}No hourly data${NC}"
    fi

    echo ""

    # ========== BEADS STATUS ==========
    echo -e "${YELLOW}BEADS${NC}"
    if command -v bd &> /dev/null && [ -d ".beads" -o -f ".beads.jsonl" ]; then
        READY=$(bd ready --json 2>/dev/null | jq -r 'length' 2>/dev/null || echo "?")
        IN_PROG=$(bd list --status in_progress --json 2>/dev/null | jq -r 'length' 2>/dev/null || echo "?")
        BLOCKED=$(bd list --status blocked --json 2>/dev/null | jq -r 'length' 2>/dev/null || echo "?")
        printf "  Ready: %s  In Progress: %s  Blocked: %s\n" "$READY" "$IN_PROG" "$BLOCKED"
    else
        echo -e "  ${DIM}Not initialized${NC}"
    fi

    echo ""
    echo -e "${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    echo -e "${DIM}30s refresh | Ctrl-C exit${NC}"

    sleep 30
done
MONITOR_SCRIPT
}

# ============================================
# Main session launcher
# ============================================

start_session() {
    local PROJECT_DIR="${1:-$(pwd)}"
    PROJECT_DIR=$(cd "$PROJECT_DIR" 2>/dev/null && pwd) || {
        echo -e "${RED}Directory not found: $1${NC}"
        exit 1
    }
    
    local PROJECT_NAME=$(basename "$PROJECT_DIR")
    local SESSION_NAME="vamp-$(echo "$PROJECT_NAME" | tr '.:' '-')"
    
    echo -e "${CYAN}‚ô™ vamp${NC} ${DIM}v${VAMP_VERSION}${NC}"
    echo -e "${GREEN}Project:${NC} $PROJECT_NAME"
    echo -e "${GREEN}Path:${NC} $PROJECT_DIR"
    
    # Check if session exists
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${YELLOW}Session exists. Attaching...${NC}"
        tmux attach-session -t "$SESSION_NAME"
        return 0
    fi
    
    # Validate tools
    if ! command -v tmux &> /dev/null; then
        echo -e "${RED}tmux not found. Install with: brew install tmux${NC}"
        exit 1
    fi
    
    # Fallbacks for optional tools
    command -v "$FILE_VIEWER" &> /dev/null || FILE_VIEWER="ls -la && echo 'Install yazi: brew install yazi'"
    command -v "$MONITOR_CMD" &> /dev/null || MONITOR_CMD="top"
    
    # Check beads status
    local BEADS_INIT=""
    [ -d "$PROJECT_DIR/.beads" ] || [ -f "$PROJECT_DIR/.beads.jsonl" ] && BEADS_INIT="yes"
    
    # Create monitor script
    local MONITOR_SCRIPT="/tmp/vamp-claude-monitor-$$.sh"
    create_claude_monitor > "$MONITOR_SCRIPT"
    chmod +x "$MONITOR_SCRIPT"
    
    # ============================================
    # Create tmux session
    # ============================================
    # Layout:
    # +-------------------+--------+
    # |                   |        |
    # |   Claude Code     | Files  |
    # |                   |        |
    # +-------------------+--------+
    # |  Shell/Beads      | Monitor|
    # +-------------------+--------+
    
    tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_DIR" -x "$(tput cols)" -y "$(tput lines)"
    tmux rename-window -t "$SESSION_NAME:0" "main"

    # Enable mouse support (scoped to this session only)
    tmux set-option -t "$SESSION_NAME" mouse on
    tmux set-option -t "$SESSION_NAME" focus-events on

    # Status bar with vamp version
    tmux set-option -t "$SESSION_NAME" status-right "vamp v${VAMP_VERSION} | %H:%M"
    tmux set-option -t "$SESSION_NAME" status-style "bg=colour236,fg=colour248"

    # Split: left 70% | right 30%
    tmux split-window -t "$SESSION_NAME:0" -h -p 30 -c "$PROJECT_DIR"
    
    # Split right pane: top files | bottom monitor
    tmux split-window -t "$SESSION_NAME:0.1" -v -p 40 -c "$PROJECT_DIR"
    
    # Split left pane: top claude | bottom shell
    tmux select-pane -t "$SESSION_NAME:0.0"
    tmux split-window -t "$SESSION_NAME:0.0" -v -p 25 -c "$PROJECT_DIR"
    
    # Pane 0: Claude Code
    tmux send-keys -t "$SESSION_NAME:0.0" "cd '$PROJECT_DIR' && clear && echo 'üéπ Claude Code' && $CLAUDE_CMD" Enter
    
    # Pane 1: Shell with beads
    tmux send-keys -t "$SESSION_NAME:0.1" "cd '$PROJECT_DIR' && clear" Enter
    if [ -n "$BEADS_INIT" ]; then
        tmux send-keys -t "$SESSION_NAME:0.1" "echo 'üìø Beads' && bd ready" Enter
    else
        tmux send-keys -t "$SESSION_NAME:0.1" "echo 'üíª Shell (bd init for beads)'" Enter
    fi
    
    # Pane 2: File viewer
    tmux send-keys -t "$SESSION_NAME:0.2" "cd '$PROJECT_DIR' && $FILE_VIEWER" Enter
    
    # Pane 3: System monitor
    tmux send-keys -t "$SESSION_NAME:0.3" "$MONITOR_CMD" Enter
    
    # Focus Claude pane
    tmux select-pane -t "$SESSION_NAME:0.0"
    
    # Window 1: Git
    tmux new-window -t "$SESSION_NAME" -n "git" -c "$PROJECT_DIR"
    if command -v lazygit &> /dev/null; then
        tmux send-keys -t "$SESSION_NAME:git" "lazygit" Enter
    else
        tmux send-keys -t "$SESSION_NAME:git" "git status" Enter
    fi
    
    # Window 2: Claude monitor
    tmux new-window -t "$SESSION_NAME" -n "monitor" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:monitor" "cd '$PROJECT_DIR' && $MONITOR_SCRIPT" Enter
    
    # Back to main
    tmux select-window -t "$SESSION_NAME:0"
    
    echo ""
    echo -e "${CYAN}Keybindings:${NC}"
    echo "  Ctrl-b + arrows  Navigate panes"
    echo "  Ctrl-b + z       Zoom pane"
    echo "  Ctrl-b + d       Detach"
    echo "  Ctrl-b + 0/1/2   Switch windows"
    echo ""
    echo -e "${CYAN}Mouse:${NC}"
    echo "  Scroll           Scroll content"
    echo "  Click            Select pane"
    echo "  Drag border      Resize pane"
    echo ""

    tmux attach-session -t "$SESSION_NAME"
}

# ============================================
# Main entry point
# ============================================

case "${1:-}" in
    help|--help|-h)
        show_help
        ;;
    list|ls)
        list_sessions
        ;;
    attach|a)
        attach_session "$2"
        ;;
    kill|k)
        kill_session "$2"
        ;;
    killall)
        kill_all_sessions
        ;;
    init)
        init_project
        ;;
    setup)
        setup_beads
        ;;
    version|--version|-v)
        echo "vamp v${VAMP_VERSION}"
        ;;
    *)
        start_session "$1"
        ;;
esac
